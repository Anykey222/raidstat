name: Build and Release

on:
  push:
    tags:
      - 'v*'  # –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–µ–≥–∞ –≤–µ—Ä—Å–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, v1.0.0)

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Run tests
      run: |
        pip install pytest
        $env:PYTHONIOENCODING = "utf-8"
        pytest tests/ -v
      shell: pwsh

    - name: Build executable
      run: |
        pyinstaller raidstat.spec
    
    - name: Get version from tag
      id: get_version
      run: |
        $version = $env:GITHUB_REF -replace 'refs/tags/', ''
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
      shell: pwsh
    
    - name: Create archive
      run: |
        $version = "${{ steps.get_version.outputs.VERSION }}"
        Compress-Archive -Path dist/RaidStat/* -DestinationPath "RaidStat-$version.zip"
      shell: pwsh
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: RaidStat-${{ steps.get_version.outputs.VERSION }}.zip
        body: |
          ## üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞
          
          1. –°–∫–∞—á–∞–π—Ç–µ –∞—Ä—Ö–∏–≤ `RaidStat-${{ steps.get_version.outputs.VERSION }}.zip`
          2. –†–∞—Å–ø–∞–∫—É–π—Ç–µ –≤ –ª—é–±—É—é –ø–∞–ø–∫—É
          3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ `RaidStat.exe`
          
          ## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
          
          –≠—Ç–æ—Ç —Ä–µ–ª–∏–∑ —Å–æ–±—Ä–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ GitHub Actions –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞.
          –í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å —Å–±–æ—Ä–∫–∏ –≤–æ –≤–∫–ª–∞–¥–∫–µ [Actions](https://github.com/${{ github.repository }}/actions).
          
          ## üìù –ò–∑–º–µ–Ω–µ–Ω–∏—è
          
          –°–º. [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
